{% extends "_layout.twig" %}

{% block title %}Articles | Bethesda Ministry
{% endblock %}

{% block content %}
  <div
    class="container">

    {# Hero Section #}
    <section class="hero" style="background: url('/assets/images/hero-img.jpg') center/cover no-repeat;">
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <h1>Explore Our Latest Articles</h1>
        <p>Deepen your faith and knowledge with our latest insights.</p>
      </div>
    </section>

    {# Fetch All Unique Categories from Articles #}
    {% set allCategories = [] %}
    {% for article in craft.entries().section('articles').all() %}
      {% set category = article.articleCategory.value ?? 'Uncategorized' %}
      {% if category not in allCategories %}
        {% set allCategories = allCategories|merge([category]) %}
      {% endif %}
    {% endfor %}

      {# Search & Filter Section #}
      <section class="search-filter-section">
        <form method="get" class="search-form">
          <input type="text" name="q" placeholder="Search articles..." value="{{ craft.app.request.getParam('q') }}">
          <button type="submit" class="button">Search</button>
        </form>

        <form method="get" class="filter-form">
          <label for="category">Filter by Category:</label>
          <select name="category" id="category" onchange="this.form.submit()">
            <option value="">All Categories</option>
            {% for category in allCategories %}
              <option value="{{ category }}" {% if craft.app.request.getParam('category') == category %} selected {% endif %}>
                {{ category }}
              </option>
            {% endfor %}
          </select>
        </form>
      </section>

    {# Fetch Articles Based on Filters #}
    {% set categoryFilter = craft.app.request.getParam('category') %}
    {% set searchQuery = craft.app.request.getParam('q') %}
    {% set articlesQuery = craft.entries().section('articles') %}

    {% if categoryFilter %}
      {% set articlesQuery = articlesQuery.articleCategory(categoryFilter) %}
    {% endif %}

    {% if searchQuery %}
      {% set articlesQuery = articlesQuery.search(searchQuery) %}
    {% endif %}

    {# Articles Grid Layout #}
    <section class="articles-grid">
      {% for article in articlesQuery.all() %}
        <div class="article-card" data-category="{{ article.articleCategory.value ?? 'Uncategorized' }}">
          {% set image = article.articleImage.one() ?? null %}
          {% if image %}
            <img src="{{ image.url }}" alt="{{ article.title }}">
          {% endif %}
          <div class="article-content">
          <h3> {{ article.title }}</h3>
            <p>
              <strong>Category:</strong>
              {{ article.articleCategory.value ?? 'Uncategorized' }}</p>
            <p>{{ article.articleContent|striptags|slice(0, 90) ~ '...' }}</p>
            <a href="{{ article.url }}" class="button">Read More</a>
          </div>
        </div>
      {% else %}
        <p class="text-error">No articles found.</p>
      {% endfor %}
    </section>

  </div>
{% endblock %}
