{% extends "_layout.twig" %}

{% block content %}
  {% set searchQuery = craft.app.request.getParam('q') %}
  {% set typeFilter = craft.app.request.getParam('type') %}
  {% set statusFilter = craft.app.request.getParam('status') %}

  {% set entriesQuery = craft.entries()
    .section(typeFilter in ['sermons', 'events'] ? typeFilter : ['sermons', 'events']) %}

  {% if searchQuery %}
    {% set entriesQuery = entriesQuery.search(searchQuery) %}
  {% endif %}

  <div class="container">

    {# Hero Section with Upcoming Event/Sermon #}
    {% set upcomingEvents = craft.entries().section('events').eventDate('>= ' ~ now|atom).all() %}
    {% set upcomingSermons = craft.entries().section('sermons').sermonDate('>= ' ~ now|atom).all() %}
    {% set allUpcoming = (upcomingEvents|merge(upcomingSermons))|filter(entry => (entry.eventDate or entry.sermonDate)) %}
    {% set sortedUpcoming = allUpcoming|sort((a, b) => (a.eventDate ?? a.sermonDate)|date('U') <=> (b.eventDate ?? b.sermonDate)|date('U')) %}
    {% set nextUpcoming = sortedUpcoming|first %}
    {% set image = nextUpcoming.sermonImage.one() ?? nextUpcoming.eventImage.one() %}

    {# Hero Section for Activities #}
    <section class="hero" style="background: url('/assets/images/hero-img.jpg') center/cover no-repeat;">
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <h1>Engage, Worship, and Grow</h1>
        <p>Discover upcoming events, powerful sermons, and meaningful ways to connect with our community.</p>
      </div>
    </section>

    {# Upcoming Event/Sermon Section #}
    {% if nextUpcoming %}
      <section class="upcoming-event">
        <div class="event-card">
          <div class="event-image" style="background-image: url('{{ image ? image.url : '/assets/default-placeholder.jpg' }}');"></div>
          <div class="event-content">
            <h2>{{ nextUpcoming.title }}</h2>
            <p>
              {% if nextUpcoming.section.handle == 'events' %}
                {{ nextUpcoming.eventDescription }}
              {% else %}
                {{ nextUpcoming.sermonDescription }}
              {% endif %}
            </p>
            <p>
              <strong>Date:</strong>
              {{ (nextUpcoming.eventDate ?? nextUpcoming.sermonDate)|date('F j, Y') }}</p>
            <a href="{{ nextUpcoming.url }}" class="event-link">View Event â†’</a>
          </div>
        </div>
      </section>
    {% endif %}

    {# Search Bar #}
    <section class="search-section">
      <form method="get" class="search-form">
        <input type="text" name="q" placeholder="Search for events or sermons" value="{{ searchQuery }}">
        <button type="submit" class="button">Search</button>
      </form>
    </section>

    {# Filter Buttons #}
    <section class="filter-section">
      <div class="filter-buttons">
        <div class="filter-group">
          <button type="button" class="filter-btn" data-filter="events">Events</button>
          <button type="button" class="filter-btn" data-filter="sermons">Sermons</button>
        </div>

        <div class="filter-group">
          <button type="button" class="filter-btn" data-filter="upcoming">Upcoming</button>
          <button type="button" class="filter-btn" data-filter="past">Past</button>
        </div>
      </div>
    </section>

    {# Container for Filtered Entries #}
    <section class="entries-section">
      <div id="entries-container" class="sermon-event-grid">
        {% for entry in entriesQuery.all() %}
          <div class="sermon-event-card" data-type="{{ entry.section.handle }}" data-status="{{ (entry.eventDate ?? entry.sermonDate) >= now ? 'upcoming' : 'past' }}">
            {% set image = entry.sermonImage.one() ?? entry.eventImage.one() ?? null %}
            <img src="{{ image ? image.url : '/assets/default-placeholder.jpg' }}" alt="{{ entry.title }}">
            <h3>{{ entry.title }}</h3>
            <p>
              <strong>Date:</strong>
              {{ (entry.eventDate ?? entry.sermonDate)|date('F j, Y') }}</p>
            <a href="{{ entry.url }}" class="button">View Details</a>
          </div>
        {% else %}
          <p class="text-error">No results found.</p>
        {% endfor %}
      </div>
    </section>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const buttons = document.querySelectorAll(".filter-btn");
      const entries = document.querySelectorAll(".sermon-event-card");

      let activeFilters = {
        type: [],
        status: []
      };

      function filterEntries() {
        entries.forEach(entry => {
          const entryType = entry.dataset.type;
          const entryStatus = entry.dataset.status;
          const typeMatch = activeFilters.type.length === 0 || activeFilters.type.includes(entryType);
          const statusMatch = activeFilters.status.length === 0 || activeFilters.status.includes(entryStatus);
          entry.style.display = typeMatch && statusMatch ? "block" : "none";
        });
      }

      buttons.forEach(button => {
        button.addEventListener("click", function () {
          const filterType = this.dataset.filter;
          const isActive = this.classList.contains("active");

          if (isActive) {
            this.classList.remove("active");
            activeFilters.type = activeFilters.type.filter(t => t !== filterType);
            activeFilters.status = activeFilters.status.filter(s => s !== filterType);
          } else {
            this.classList.add("active");
            if (["events", "sermons"].includes(filterType)) {
              activeFilters.type.push(filterType);
            } else {
              activeFilters.status.push(filterType);
            }
          }
          filterEntries();
        });
      });

      filterEntries();
    });
  </script>
{% endblock %}
