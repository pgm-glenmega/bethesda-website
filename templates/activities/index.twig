{% extends "_layout.twig" %}


{% block title %}Activities | Bethesda Ministry
{% endblock %}

{% block head %}
  {{ parent() }}
  <link rel="stylesheet" href="/css/activities.css?v={{ now.timestamp }}">
{% endblock %}

{% block content %}
{% set searchQuery = craft.app.request.getParam('q') %}
{% set sermonCategoryFilter = craft.app.request.getParam('sermonCategory') %}
{% set eventCategoryFilter = craft.app.request.getParam('eventCategory') %}

{% set entriesQuery = craft.entries().section(['sermons', 'events']) %}

{% if searchQuery %}
  {% set entriesQuery = entriesQuery.search(searchQuery) %}
{% endif %}
{% if sermonCategoryFilter %}
  {% set entriesQuery = entriesQuery.relatedTo({ targetElement: craft.categories().group('sermonCategories').slug(sermonCategoryFilter).one() }) %}
{% endif %}
{% if eventCategoryFilter %}
  {% set entriesQuery = entriesQuery.relatedTo({ targetElement: craft.categories().group('eventCategories').slug(eventCategoryFilter).one() }) %}
{% endif %}

<div class="container activities-page">

  {# Hero Section #}
  {% set pageEntry = craft.entries().section('activitiesPage').one() %}
  {% set hero = pageEntry.heroBackground.one() ?? null %}
  <section class="hero" style="background-image:url('{{ hero ? hero.url : '/assets/images/hero-img.jpg' }}')">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1>{{ pageEntry.heroHeading }}</h1>
      <p>{{ pageEntry.heroSubheading }}</p>
    </div>
  </section>

  {# Search & Filters #}
  <section class="search-section">
    <form method="get" class="search-form">
      <input type="text" name="q" placeholder="Search for events or sermons" value="{{ searchQuery }}" aria-label="Search">

      <select id="eventCategory" name="eventCategory" onchange="this.form.submit()">
        <option value="">All Events</option>
        {% for cat in craft.categories().group('eventCategories').all() %}
          <option value="{{ cat.slug }}" {{ eventCategoryFilter == cat.slug ? 'selected' : '' }}>{{ cat.title }}</option>
        {% endfor %}
      </select>

      <select id="sermonCategory" name="sermonCategory" onchange="this.form.submit()">
        <option value="">All Sermons</option>
        {% for cat in craft.categories().group('sermonCategories').all() %}
          <option value="{{ cat.slug }}" {{ sermonCategoryFilter == cat.slug ? 'selected' : '' }}>{{ cat.title }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="button">Search</button>
    </form>
  </section>

{# Entries Grid #}
<section class="entries-section">
  <div class="grid grid--cards">
    {% for entry in entriesQuery.all() %}
      <div class="card" data-type="{{ entry.section.handle }}" data-status="{{ (entry.eventDate ?? entry.sermonDate) >= now ? 'upcoming' : 'past' }}">

        {% set image = entry.sermonImage.one() ?? entry.eventImage.one() %}
        <img src="{{ image ? image.url : '/assets/default-placeholder.jpg' }}" alt="{{ entry.title }}">

        <h3>{{ entry.title|length > 21 ? entry.title|slice(0, 21) ~ '...' : entry.title }}</h3>

        {% set category = entry.section.handle == 'sermons' ? entry.sermonCategory.one() : entry.eventCategory.one() %}
        {% if category %}
          <span class="badge" style="background-color: {{ category.sermonCategoryColor ?? category.eventCategoryColor }}">
            {{ category.title }}
          </span>
        {% endif %}

        <div class="chips">
          {% if entry.section.handle == 'sermons' %}
            {% set tags = entry.sermonTags.all() %}
          {% else %}
            {% set tags = entry.eventTags.all() %}
          {% endif %}

          {% for tag in tags %}
            <a class="chip" href="{{ url('activities/tag/' ~ tag.slug) }}">#{{ tag.title }}</a>
          {% endfor %}
        </div>

        <p class="date"><strong>Date:</strong> {{ (entry.eventDate ?? entry.sermonDate)|date('F j, Y') }}</p>
        <p>{{ (entry.eventDescription ?? entry.sermonDescription)|slice(0, 70) ~ '...' }}</p>

        <a href="{{ entry.url }}" class="button">View Details</a>
      </div>
    {% else %}
      <p class="text-error">No results found.</p>
    {% endfor %}
  </div>
</section>


</div>
<script defer src="{{ url('js/activity-filter.js') }}"></script>
{% endblock %}
