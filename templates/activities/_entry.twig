{% extends '_layout.twig' %}

{% block title %}
  {{ entry.title }}
  | Bethesda Ministry
{% endblock %}

{% block content %}
  <div
    class="container sermon-detail">

    {# Sermon Hero Section #}
    {% set sermonHeroImage = entry.sermonImage.one() %}
    <section class="hero" style="background: url('{{ sermonHeroImage ? sermonHeroImage.url : '/assets/images/hero-img.jpg' }}') center/cover no-repeat;">
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <h1>{{ entry.title }}</h1>
        <p class="sermon-meta">
          <strong>Date:</strong>
          {{ entry.sermonDate|date('F j, Y') }}
          |
          <strong>Speaker:</strong>
          {{ entry.speakerName }}</p>
      </div>
    </section>

    {# Sermon Content Section #}
    <section class="sermon-content">
      <div class="sermon-info">
        <h2>About This Sermon</h2>
        <p>{{ entry.sermonDescription }}</p>

        <div class="sermon-speaker">
          {% set speakerImage = entry.speakerImage.one() %}
          <img src="{{ speakerImage ? speakerImage.url : '/assets/images/speaker.jpg' }}" alt="Speaker {{ entry.speakerName }}">
          <div>
            <h3>{{ entry.speakerName }}</h3>
            <p>Bringing powerful messages of faith and transformation.</p>
          </div>
        </div>
      </div>

      {# Media Section #}
      <div class="sermon-media">
        {% if entry.sermonVideoUrl is not empty %}
          {% set videoUrl = entry.sermonVideoUrl is iterable ? entry.sermonVideoUrl|first : entry.sermonVideoUrl %}
          {% set youtubeId = videoUrl|replace({
        'https://www.youtube.com/watch?v=': '',
        'https://youtu.be/': '',
        'https://www.youtube.com/live/': ''
      })|split('?')|first %}
          <div class="sermon-video">
            <iframe width="100%" height="400" src="https://www.youtube.com/embed/{{ youtubeId|trim }}" frameborder="0" allowfullscreen></iframe>
          </div>
        {% endif %}

        {% if entry.sermonAudioFile|length %}
          <div class="sermon-audio">
            <h2>Listen to Audio</h2>
            <audio controls>
              <source src="{{ entry.sermonAudioFile.one().url }}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
          </div>
        {% endif %}
      </div>
    </section>

    {# Signup Section #}
    <section class="sermon-signup">
      <h2>Join This Sermon</h2>
      <p>Be part of this impactful message by signing up below.</p>

      {% if craft.app.session.getFlash('successMessage') %}
        <p class="success-message">{{ craft.app.session.getFlash('successMessage') }}</p>
      {% endif %}
      {% if craft.app.session.getFlash('errorMessage') %}
        <p class="error-message">{{ craft.app.session.getFlash('errorMessage') }}</p>
      {% endif %}

      <form method="post" action="">
        {{ csrfInput() }}
        <input type="hidden" name="action" value="entries/save-entry">
        <input type="hidden" name="sectionId" value="9">
        <input type="hidden" name="fields[relatedSermon][]" value="{{ entry.id }}">

        <div class="form-group">
          <label for="name">Your Name:</label>
          <input type="text" id="name" name="fields[attendeeName]" required>
        </div>

        <div class="form-group">
          <label for="email">Your Email:</label>
          <input type="email" id="email" name="fields[attendeeEmail]" required>
        </div>

        <button type="submit" class="button primary">Sign Up</button>
      </form>
    </section>

    {# Related Sermons Section #}
    <section class="related-sermons">
      <h2>More Sermons</h2>
      <div class="sermon-cards">
        {% for related in craft.entries().section('sermons').limit(3).all() %}
          <div class="sermon-card">
            <img src="{{ related.sermonImage.one().url }}" alt="{{ related.title }}">
            <h3>
              <a href="{{ related.url }}">{{ related.title }}</a>
            </h3>
            <p>
              <strong>Speaker:</strong>
              {{ related.speakerName }}</p>
            <p>
              <strong>Date:</strong>
              {{ related.sermonDate|date('F j, Y') }}</p>
            <p>{{ related.sermonDescription|slice(0, 100) ~ '...' }}</p>
            <a href="{{ related.url }}" class="sermon-card-link">View activity â†’</a>
          </div>
        {% endfor %}
      </div>
    </section>

    {# back to sermons #}
    <div class="back-container">
      <a href="{{ url('sermons') }}" class="btn-back">Back to activities</a>
    </div>
  {% endblock %}
